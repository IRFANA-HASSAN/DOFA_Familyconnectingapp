<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/Home.css' %}">
    <title>User Location Interface</title>
</head>
<body>
    <div class="background"></div>
    <div class="dot-pattern"></div>
    
    <div class="map-container">
        <!-- Family graph container -->
        <div id="family-graph" style="position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center;"></div>
        <!-- Floating node popup -->
        <div id="node-popup" style="position:absolute; display:none; min-width:240px; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.18); padding:12px; z-index:12; pointer-events:auto;"></div>
        
        <div class="navigation">
            <ul>
                <li class="list active">
                    <a href="{% url 'notification' %}">
                        <span class="icon">
                            <img src="{% static 'assets/notification.svg' %}" alt="">
                        </span>
                    </a>
                </li>
                <li class="list">
                    <a href="{% url 'search' %}">
                        <span class="icon">
                            <img src="{% static 'assets/search.svg' %}" alt="">
                        </span>
                    </a>
                </li>
                <li class="list">
                    <a href="{% url 'profile-page' %}">
                        <span class="icon"><img src="{% static 'assets/profile.png' %}" alt=""></span>
                    </a>
                </li>
                <div class="indicator"></div>
            </ul>
        </div>
        
        <div class="user-details" id="userDetails">
            {% if profile_image_url %}
                <img src="{{ profile_image_url }}" alt="User Profile" id="userDetailPhoto" class="user-photo">
            {% else %}
                <img src="{% static 'assets/np.png' %}" alt="User Profile" id="userDetailPhoto" class="user-photo">
            {% endif %}
            <div class="user-info">
                <h3 id="userDetailName">{{ user_name }}</h3>
                <p id="userDetailLocation">{{ user_location }}</p>
            </div>
        </div>
    </div>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', async function () {
    try {
        const res = await fetch('/api/family-graph/');
        const data = await res.json();
        if (!data.success) {
            console.error('Failed to load family graph');
            return;
        }

        const container = document.getElementById('family-graph');
        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3.select('#family-graph')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .style('pointer-events', 'auto');

        const viewport = svg.append('g').attr('class', 'viewport');
        
        const zoom = d3.zoom()
            .scaleExtent([0.3, 3])
            .on('zoom', (event) => {
                viewport.attr('transform', event.transform);
            });
        
        svg.call(zoom);

        const defaultAvatar = '{% static "assets/np.png" %}';

        // Create image patterns for profile photos
        const defs = svg.append('defs');
        data.nodes.forEach(n => {
            const url = n.profile_image || defaultAvatar;
            const p = defs.append('pattern')
                .attr('id', `node-img-${n.id}`)
                .attr('patternUnits', 'objectBoundingBox')
                .attr('width', 1)
                .attr('height', 1);
            p.append('image')
                .attr('href', url)
                .attr('width', 100)
                .attr('height', 100)
                .attr('preserveAspectRatio', 'xMidYMid slice');
        });

        // Build tree hierarchy
        const idToNode = new Map(data.nodes.map(n => [n.id, n]));
        const childrenMap = new Map();
        
        data.links.forEach(l => {
            const s = (l.source.id ?? l.source);
            const t = (l.target.id ?? l.target);
            if (!childrenMap.has(s)) childrenMap.set(s, []);
            childrenMap.get(s).push(t);
        });
        
        function buildTree(id, visited = new Set()) {
            visited.add(id);
            const src = idToNode.get(id);
            const kids = (childrenMap.get(id) || [])
                .filter(cid => !visited.has(cid))
                .map(cid => buildTree(cid, visited));
            return { 
                id, 
                name: src?.name || '', 
                job: src?.job || '', 
                profile_image: src?.profile_image || null, 
                is_me: src?.is_me || false, 
                children: kids 
            };
        }
        
        const rootData = buildTree(data.current_user_id);
        const root = d3.hierarchy(rootData);
        
        // BOTTOM TO TOP LAYOUT - Root at bottom, children grow upward
        const margin = { top: 80, right: 60, bottom: 40, left: 60 };
        const treeWidth = width - margin.left - margin.right;
        const treeHeight = height - margin.top - margin.bottom;
        
        const treeLayout = d3.tree()
            .size([treeWidth, treeHeight])
            .separation((a, b) => (a.parent === b.parent ? 1 : 1.2));
        
        treeLayout(root);

        // VERTICAL link generator (BOTTOM to TOP - inverted Y)
        const linkGen = d3.linkVertical()
            .x(d => d.x + margin.left)
            .y(d => height - d.y - margin.bottom); // INVERTED: subtract from height

        // Draw links
        viewport.append('g')
            .attr('fill', 'none')
            .attr('stroke', '#c5d9e8')
            .attr('stroke-width', 2)
            .selectAll('path')
            .data(root.links())
            .enter()
            .append('path')
            .attr('d', linkGen);

        // Draw nodes with INVERTED Y position
        const node = viewport.append('g')
            .selectAll('g')
            .data(root.descendants())
            .enter()
            .append('g')
            .attr('transform', d => `translate(${d.x + margin.left}, ${height - d.y - margin.bottom})`); // INVERTED Y

        node.append('circle')
            .attr('r', d => d.data.is_me ? 28 : 20)
            .attr('fill', d => `url(#node-img-${d.data.id})`)
            .attr('stroke', d => d.data.is_me ? '#6B9DC6' : '#c5d9e8')
            .attr('stroke-width', d => d.data.is_me ? 4 : 3)
            .style('cursor', 'pointer');

        // Text ABOVE the circles (negative Y for bottom-to-top)
        node.append('text')
            .attr('x', 0)
            .attr('y', d => d.data.is_me ? -35 : -28) // NEGATIVE: text above circle
            .attr('text-anchor', 'middle')
            .attr('font-size', 12)
            .attr('font-weight', d => d.data.is_me ? 600 : 500)
            .attr('fill', '#333')
            .text(d => d.data.name);

        // Center on current user (root node at bottom center)
        const rootNode = root.descendants().find(d => d.data.is_me) || root.descendants()[0];
        const initialScale = width < 768 ? 0.6 : 0.8;
        
        // Position root node at bottom-center of viewport
        const initialTransform = d3.zoomIdentity
            .translate(width / 2, height * 0.75) // Position at lower part of screen
            .scale(initialScale)
            .translate(-rootNode.x - margin.left, -(height - rootNode.y - margin.bottom));
        
        svg.call(zoom.transform, initialTransform);

        // Update user details in header
        const currentUser = idToNode.get(data.current_user_id);
        if (currentUser) {
            const photoEl = document.getElementById('userDetailPhoto');
            const nameEl = document.getElementById('userDetailName');
            const locationEl = document.getElementById('userDetailLocation');
            
            if (photoEl) photoEl.src = currentUser.profile_image || defaultAvatar;
            if (nameEl) nameEl.textContent = currentUser.name;
            if (locationEl && currentUser.location) locationEl.textContent = currentUser.location;
        }

        // Popup functionality
        const popup = document.getElementById('node-popup');

        function openPopup(evt, d) {
            const myId = data.current_user_id;
            let relLabel = '';
            
            for (const l of data.links) {
                if ((l.source.id ?? l.source) === myId && (l.target.id ?? l.target) === d.id) {
                    relLabel = l.label;
                    break;
                }
                if ((l.target.id ?? l.target) === myId && (l.source.id ?? l.source) === d.id) {
                    relLabel = l.label;
                    break;
                }
            }
            
            const img = d.profile_image || defaultAvatar;
            popup.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;">
                    <img src="${img}" alt="${d.name}" style="width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid #6B9DC6;">
                    <div>
                        <div style="font-weight:700;color:#0a3d74;font-size:14px;">${d.name}</div>
                        <div style="font-size:11px;color:#666;">${d.job || 'No job info'}</div>
                    </div>
                </div>
                ${d.is_me ? '<div style="margin-top:6px;font-size:11px;color:#0a3d74;font-weight:bold;">You</div>' : ''}
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid #eee;font-size:12px;color:#333">
                    Relation: <span style="background:#e8f0ff;color:#0a3d74;padding:4px 8px;border-radius:12px;font-size:11px;">${relLabel || '—'}</span>
                </div>
                <div id="actionRow" style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;"></div>
            `;
            
            const containerRect = container.getBoundingClientRect();
            const popupWidth = 260;
            const popupHeight = 200;
            
            let left = evt.clientX - containerRect.left + 12;
            let top = evt.clientY - containerRect.top - 10;
            
            if (left + popupWidth > containerRect.width) left = containerRect.width - popupWidth - 12;
            if (left < 12) left = 12;
            if (top + popupHeight > containerRect.height) top = containerRect.height - popupHeight - 12;
            if (top < 12) top = 12;
            
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
            popup.style.display = 'block';
            
            const actionRow = popup.querySelector('#actionRow');
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = 'background:#0a3d74;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:11px;';
            closeBtn.onclick = () => popup.style.display = 'none';
            
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'View Profile';
            viewBtn.style.cssText = 'background:#4A90E2;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:11px;';
            viewBtn.onclick = () => window.location.href = `/profile/${d.id}/tree/`;
            actionRow.appendChild(viewBtn);

            if (!d.is_me) {
                fetch(`/api/relation-status/?user_id=${d.id}`)
                    .then(r => r.json())
                    .then(st => {
                        if (st.success) {
                            if (st.related) {
                                const relatedBtn = document.createElement('button');
                                relatedBtn.textContent = 'Related';
                                relatedBtn.style.cssText = 'background:#e8f0ff;color:#0a3d74;border:none;border-radius:6px;padding:6px 12px;cursor:default;font-size:11px;';
                                actionRow.appendChild(relatedBtn);
                            } else if (st.pending) {
                                const pendingBtn = document.createElement('button');
                                pendingBtn.textContent = 'Pending';
                                pendingBtn.style.cssText = 'background:#fff3cd;color:#856404;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:11px;';
                                if (st.outgoing_id) {
                                    pendingBtn.title = 'Click to withdraw';
                                    pendingBtn.onclick = async () => {
                                        if (!confirm('Withdraw this relation request?')) return;
                                        try {
                                            const res = await fetch('/api/relation-withdraw/', {
                                                method: 'POST',
                                                headers: { 
                                                    'Content-Type': 'application/json', 
                                                    'X-CSRFToken': getCookie('csrftoken') 
                                                },
                                                body: JSON.stringify({ relationship_id: st.outgoing_id })
                                            });
                                            const rj = await res.json();
                                            if (rj.success) { 
                                                popup.style.display = 'none'; 
                                                alert('Request withdrawn successfully'); 
                                            } else { 
                                                alert('Error: ' + rj.message); 
                                            }
                                        } catch(e) { 
                                            alert('Network error'); 
                                        }
                                    };
                                }
                                actionRow.appendChild(pendingBtn);
                            } else {
                                const relateBtn = document.createElement('button');
                                relateBtn.textContent = 'Relate';
                                relateBtn.style.cssText = 'background:#28a745;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:11px;';
                                relateBtn.onclick = () => window.location.href = '{% url "search" %}';
                                actionRow.appendChild(relateBtn);
                            }
                        }
                        actionRow.appendChild(closeBtn);
                    })
                    .catch(() => { 
                        actionRow.appendChild(closeBtn); 
                    });
            } else {
                actionRow.appendChild(closeBtn);
            }
        }

        node.on('click', (evt, d) => {
            evt.stopPropagation();
            openPopup(evt, idToNode.get(d.data.id));
        });

        svg.on('click', () => {
            popup.style.display = 'none';
        });

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                const newWidth = container.clientWidth;
                const newHeight = container.clientHeight;
                svg.attr('width', newWidth).attr('height', newHeight);
            }, 250);
        });

    } catch (e) {
        console.error('Graph load error:', e);
        alert('Failed to load family tree. Please refresh the page.');
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
    </script>
    <script src="{% static 'js/Home.js' %}"></script>
</body>
</html>