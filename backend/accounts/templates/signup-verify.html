<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOFA | OTP Verify</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
<section id="otp-verification">
  <div class="otp-container">
    <h2>Verify OTP</h2>
    <p>Enter the 4-digit OTP sent to your email</p>
    <div class="otp-inputs">
      <input type="text" maxlength="1" pattern="\d*">
      <input type="text" maxlength="1" pattern="\d*">
      <input type="text" maxlength="1" pattern="\d*">
      <input type="text" maxlength="1" pattern="\d*">
    </div>
    <button id="otp-submit">Submit</button>
  </div>
</section>

<script>
const otpInputs = document.querySelectorAll('.otp-inputs input');

// auto-focus behavior
otpInputs.forEach((input, idx) => {
  input.addEventListener('input', () => {
    if(input.value.length===1 && idx<otpInputs.length-1) otpInputs[idx+1].focus();
  });
  input.addEventListener('keydown', (e) => {
    if(e.key==='Backspace' && input.value==='' && idx>0) otpInputs[idx-1].focus();
  });
});

document.getElementById('otp-submit').addEventListener('click', async () => {
  const otp = Array.from(otpInputs).map(i => i.value.trim()).join('');
  if (otp.length !== 4) { alert('Enter all 4 digits'); return; }

  const token = localStorage.getItem('signup_token');
  if (!token) { alert('Token missing, please signup again.'); return; }

  try {
    const res = await fetch('/api/verify-signup/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ token, otp })  // send token, not email
    });
    const data = await res.json();
    if (data.success) {
      alert('Signup verified! You can now login.');
      localStorage.removeItem('signup_token'); // clear token
      window.location.href = '{% url "authentication-page" %}';
    } else {
      alert('Error: ' + data.message);
    }
  } catch (err) {
    console.error(err);
    alert('Something went wrong.');
  }
});
</script>

</body>
</html>
